<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Management - Engineering College</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f7fa;
        }

        .staff-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .staff-header {
            background: linear-gradient(135deg, #5b73e8 0%, #4a5fb8 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .staff-header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .staff-header p {
            margin: 0;
            opacity: 0.9;
        }

        /* Statistics Bar - Compact Single Line */
        .stats-bar {
            background: linear-gradient(135deg, #5b73e8 0%, #4a5fb8 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-bar .stat-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .stats-bar .stat-divider {
            width: 1px;
            height: 20px;
            background: rgba(255,255,255,0.3);
        }

        .stats-bar .stat-label {
            font-weight: 600;
        }

        .stats-bar .stat-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filter-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 18px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .filter-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Action Bar */
        .action-bar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none; /* Hidden by default, shown when filters applied */
        }

        .action-bar.visible {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Student List - Simple Table */
        .table-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .simple-table {
            width: 100%;
            border-collapse: collapse;
        }

        .simple-table thead {
            background: #5b73e8;
            color: white;
        }

        .simple-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .simple-table tbody tr {
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .simple-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .simple-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Selected row highlight */
        .simple-table tbody tr.selected {
            background-color: #5b73e8 !important;
            color: white !important;
            font-weight: 600;
        }
        
        .simple-table tbody tr.selected td {
            color: white !important;
        }
        
        .simple-table tbody tr.selected .admission-link {
            color: white !important;
        }

        .simple-table td {
            padding: 15px;
        }

        .simple-table .admission-link {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }

        .simple-table .admission-link:hover {
            text-decoration: underline;
        }

        /* Details Panel */
        .details-panel {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            overflow-y: auto;
            z-index: 1000;
        }

        .details-panel.open {
            right: 0;
        }

        .details-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        .details-panel-overlay.visible {
            display: block;
        }

        .details-header {
            background: linear-gradient(135deg, #5b73e8 0%, #4a5fb8 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .details-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .details-content {
            padding: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group label .required {
            color: #dc3545;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .photo-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .photo-section h4 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .current-photo {
            margin-bottom: 15px;
        }

        .current-photo img {
            max-width: 200px;
            max-height: 200px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }

        .photo-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #eee;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #5b73e8;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            color: #dc3545;
            padding: 15px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 15px 0;
        }

        .success {
            color: #155724;
            padding: 15px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            margin: 15px 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-content h3 {
            margin-top: 0;
            color: #333;
        }

        .modal-content p {
            color: #666;
            margin: 10px 0;
        }

        .modal-content input[type="file"] {
            margin: 20px 0;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            width: 100%;
            cursor: pointer;
        }

        .modal-buttons {
            margin-top: 20px;
            text-align: right;
        }

        .modal-buttons button {
            margin-left: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar::after {
            content: '';
            display: block;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: progress 1.5s linear infinite;
        }

        @keyframes progress {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .import-results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }

        .import-results h4 {
            margin-top: 0;
            color: #333;
        }

        .import-results ul {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .import-results li {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-left: 3px solid #dc3545;
            border-radius: 3px;
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .details-panel {
                width: 100%;
                right: -100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .stats-bar .stat-divider {
                display: none;
            }
        }

        /* Compact student list table rows */
        .simple-table {
            font-size: 14px;
        }

        .simple-table thead th {
            padding: 10px 12px;
            background-color: #5b73e8;
            color: white;
            font-weight: 600;
        }

        .simple-table tbody td {
            padding: 8px 12px;
            line-height: 1.3;
            vertical-align: middle;
        }

        .simple-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .simple-table tbody tr:hover {
            background-color: #f0f4ff;
        }

        .simple-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* No filter message styling */
        .no-filter-message {
            display: block;
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .no-filter-message h3 {
            margin: 0 0 10px 0;
            color: #667eea;
        }

        .no-filter-message p {
            margin: 0;
            color: #666;
        }

        /* Back to Dashboard Button */
        .back-to-dashboard {
            padding: 15px 30px;
            background: #f8f9fa;
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            color: #495057;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: #4a90e2;
            color: white;
            border-color: #4a90e2;
            transform: translateX(-5px);
        }

        .btn-back span {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="staff-container">
        <!-- Header -->
        <div class="staff-header">
            <h1>Staff Management</h1>
            <p>Manage staff members, departments, and designations</p>
        </div>

        <!-- Back to Dashboard Button -->
        <div class="back-to-dashboard">
            <a href="index.html" class="btn-back">
                <span>‚Üê Back to Dashboard</span>
            </a>
        </div>

        <!-- Statistics Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">Total:</span>
                <span class="stat-value" id="stat-total">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">Teaching:</span>
                <span class="stat-value" id="stat-teaching">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">Non-Teaching:</span>
                <span class="stat-value" id="stat-nonteaching">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">Active:</span>
                <span class="stat-value" id="stat-active">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">On Leave:</span>
                <span class="stat-value" id="stat-leave">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-label">Retired:</span>
                <span class="stat-value" id="stat-retired">0</span>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <h3>Filter Staff</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filter-department">Department</label>
                    <select id="filter-department">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-designation">Designation</label>
                    <select id="filter-designation">
                        <option value="">All Designations</option>
                        <optgroup label="Teaching">
                            <option value="Principal">Principal</option>
                            <option value="Professor">Professor</option>
                            <option value="Associate Professor">Associate Professor</option>
                            <option value="Assistant Professor">Assistant Professor</option>
                            <option value="Lecturer">Lecturer</option>
                            <option value="Lab Assistant">Lab Assistant</option>
                        </optgroup>
                        <optgroup label="Non-Teaching">
                            <option value="Superintendent">Superintendent</option>
                            <option value="Senior Assistant">Senior Assistant</option>
                            <option value="Junior Assistant">Junior Assistant</option>
                            <option value="Attender">Attender</option>
                            <option value="Lab Technician">Lab Technician</option>
                            <option value="Librarian">Librarian</option>
                            <option value="Office Assistant">Office Assistant</option>
                        </optgroup>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-status">Employment Status</label>
                    <select id="filter-status">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="On Leave">On Leave</option>
                        <option value="Retired">Retired</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filter</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar" id="action-bar">
            <div class="action-buttons">
                <button class="btn btn-success" onclick="openAddNewModal()">+ Add New Staff</button>
                <button class="btn btn-info" onclick="openImportExcelModal()">Import Excel</button>
                <button class="btn btn-info" onclick="exportToExcel()">Export Excel</button>
                <button class="btn btn-warning" onclick="openImportPhotosModal()">Import Photos</button>
                <button class="btn btn-secondary" onclick="generateSampleExcel()">Generate Sample Excel</button>
            </div>
        </div>

        <!-- Staff List Table -->
        <div class="table-section">
            <div id="no-filters-message" class="no-filter-message">
                <div style="font-size: 64px; color: #ddd;">üë•</div>
                <h3>No Filters Applied</h3>
                <p>Please select filters and click "Apply Filter" to view staff members</p>
            </div>
            <div id="staff-table-container" style="display: none;">
                <table class="simple-table" id="staff-table">
                    <thead>
                        <tr>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>Designation</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="staff-table-body">
                        <!-- Staff rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Details Panel Overlay -->
    <div class="details-panel-overlay" id="overlay" onclick="closeDetailsPanel()"></div>

    <!-- Details Panel -->
    <div class="details-panel" id="details-panel">
        <div class="details-header">
            <h3 id="panel-title">Staff Details</h3>
            <button class="close-btn" onclick="closeDetailsPanel()">√ó</button>
        </div>
        <div class="details-body">
            <!-- Photo Section -->
            <div class="photo-section">
                <div class="photo-preview" id="photo-preview">
                    <div class="photo-placeholder">üë§</div>
                </div>
                <label class="upload-btn">
                    Upload Photo
                    <input type="file" id="photo-upload" accept="image/*" onchange="handlePhotoUpload(event)">
                </label>
            </div>

            <!-- Basic Information -->
            <div class="section-title">Basic Information</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="employee_id">Employee ID *</label>
                    <input type="text" id="employee_id" readonly>
                </div>
                <div class="form-group">
                    <label for="title">Title *</label>
                    <select id="title">
                        <option value="">Select Title</option>
                        <option value="Mr">Mr</option>
                        <option value="Ms">Ms</option>
                        <option value="Mrs">Mrs</option>
                        <option value="Dr">Dr</option>
                        <option value="Prof">Prof</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="full_name">Full Name *</label>
                <input type="text" id="full_name" placeholder="Enter full name">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="department">Department *</label>
                    <select id="department">
                        <option value="">Select Department</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="designation">Designation *</label>
                    <select id="designation">
                        <option value="">Select Designation</option>
                        <optgroup label="Teaching">
                            <option value="Principal">Principal</option>
                            <option value="Professor">Professor</option>
                            <option value="Associate Professor">Associate Professor</option>
                            <option value="Assistant Professor">Assistant Professor</option>
                            <option value="Lecturer">Lecturer</option>
                            <option value="Lab Assistant">Lab Assistant</option>
                        </optgroup>
                        <optgroup label="Non-Teaching">
                            <option value="Superintendent">Superintendent</option>
                            <option value="Senior Assistant">Senior Assistant</option>
                            <option value="Junior Assistant">Junior Assistant</option>
                            <option value="Attender">Attender</option>
                            <option value="Lab Technician">Lab Technician</option>
                            <option value="Librarian">Librarian</option>
                            <option value="Office Assistant">Office Assistant</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <!-- Personal Details -->
            <div class="section-title">Personal Details</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="dob">Date of Birth</label>
                    <input type="date" id="dob">
                </div>
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="qualification">Qualification</label>
                    <input type="text" id="qualification" placeholder="e.g., M.Tech, Ph.D">
                </div>
                <div class="form-group">
                    <label for="experience">Years of Experience</label>
                    <input type="number" id="experience" min="0" step="0.5" placeholder="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="mobile">Mobile Number</label>
                    <input type="text" id="mobile" maxlength="10" placeholder="10 digits">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="email@example.com">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="joining_date">Joining Date</label>
                    <input type="date" id="joining_date">
                </div>
                <div class="form-group">
                    <label for="emergency_contact">Emergency Contact</label>
                    <input type="text" id="emergency_contact" maxlength="10" placeholder="10 digits">
                </div>
            </div>
            <div class="form-group">
                <label for="address">Address</label>
                <textarea id="address" rows="3" placeholder="Enter complete address"></textarea>
            </div>

            <!-- Account Details -->
            <div class="section-title">Account Details</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="bank_name">Bank Name</label>
                    <input type="text" id="bank_name" placeholder="Bank name">
                </div>
                <div class="form-group">
                    <label for="account_number">Account Number</label>
                    <input type="text" id="account_number" placeholder="Account number">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="ifsc_code">IFSC Code</label>
                    <input type="text" id="ifsc_code" maxlength="11" placeholder="ABCD0123456 (11 chars)">
                </div>
                <div class="form-group">
                    <label for="pan_number">PAN Number</label>
                    <input type="text" id="pan_number" maxlength="10" placeholder="ABCDE1234F">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="aadhaar_number">Aadhaar Number</label>
                    <input type="text" id="aadhaar_number" maxlength="12" placeholder="12 digits">
                </div>
                <div class="form-group">
                    <label for="uan">UAN</label>
                    <input type="text" id="uan" placeholder="Universal Account Number">
                </div>
            </div>
            <div class="form-group">
                <label for="salary">Salary</label>
                <input type="number" id="salary" min="0" step="1000" placeholder="Monthly salary">
            </div>

            <!-- Status & Flags -->
            <div class="section-title">Status & Flags</div>
            <div class="form-group">
                <label for="employment_status">Employment Status</label>
                <select id="employment_status">
                    <option value="Active">Active</option>
                    <option value="On Leave">On Leave</option>
                    <option value="Retired">Retired</option>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="is_hod">
                <label for="is_hod">Head of Department (HOD)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="is_class_coordinator">
                <label for="is_class_coordinator">Class Coordinator</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="is_exam_invigilator">
                <label for="is_exam_invigilator">Exam Invigilator</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="is_locked">
                <label for="is_locked">Account Locked</label>
            </div>
        </div>
        <div class="details-footer">
            <button class="btn btn-secondary" onclick="closeDetailsPanel()">Cancel</button>
            <button class="btn btn-primary" onclick="saveStaffDetails()">Save Changes</button>
        </div>
    </div>

    <!-- Import Excel Modal -->
    <div id="import-excel-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Staff from Excel</h2>
            </div>
            <div class="modal-body">
                <div class="info-message">
                    <p><strong>Excel Format Requirements:</strong></p>
                    <p>‚Ä¢ Use the sample Excel template for proper format</p>
                    <p>‚Ä¢ Supported format: .xlsx, .xls</p>
                    <p>‚Ä¢ Employee IDs must be unique</p>
                </div>
                <div class="file-input-group">
                    <label for="excel-file-input">Select Excel File</label>
                    <input type="file" id="excel-file-input" accept=".xlsx,.xls">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportExcelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="uploadExcelFile()">Upload & Import</button>
            </div>
        </div>
    </div>

    <!-- Import Photos Modal -->
    <div id="import-photos-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Staff Photos</h2>
            </div>
            <div class="modal-body">
                <div class="info-message">
                    <p><strong>Photo Import Requirements:</strong></p>
                    <p>‚Ä¢ Upload a ZIP file containing staff photos</p>
                    <p>‚Ä¢ Photo filename must match Employee ID (e.g., EMP001.jpg)</p>
                    <p>‚Ä¢ Supported formats: .jpg, .jpeg, .png</p>
                </div>
                <div class="file-input-group">
                    <label for="photos-zip-input">Select ZIP File</label>
                    <input type="file" id="photos-zip-input" accept=".zip">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportPhotosModal()">Cancel</button>
                <button class="btn btn-primary" onclick="uploadPhotosZip()">Upload & Import</button>
            </div>
        </div>
    </div>


    <script>
        console.log('Staff Management System initialized');

        let staffData = [];
        let departments = [];
        let currentStaffId = null;
        let filtersApplied = false;
        
        // Default statistics object with zero values - single source of truth
        const DEFAULT_STATS = {
            total: 0,
            teaching: 0,
            non_teaching: 0,
            active: 0,
            on_leave: 0,
            retired: 0
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing staff management...');
            loadDepartments();
            loadStatistics();
            setupKeyboardShortcuts();
        });

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    console.log('ESC key pressed');
                    closeDetailsPanel();
                    closeImportExcelModal();
                    closeImportPhotosModal();
                }
            });
        }

        async function loadDepartments() {
            try {
                console.log('Loading departments...');
                const response = await fetch('/api/departments');
                if (!response.ok) throw new Error('Failed to fetch departments');
                departments = await response.json();
                console.log('Departments loaded:', departments);
                populateDepartmentDropdowns();
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        function populateDepartmentDropdowns() {
            const filterDept = document.getElementById('filter-department');
            const formDept = document.getElementById('department');
            departments.forEach(dept => {
                filterDept.add(new Option(dept.dept_code, dept.dept_id));
                formDept.add(new Option(dept.dept_code, dept.dept_id));
            });
            console.log('Department dropdowns populated');
        }

        async function loadStatistics() {
            try {
                console.log('Loading statistics...');
                const response = await fetch('/api/staff');
                if (!response.ok) throw new Error('Failed to fetch statistics');
                const result = await response.json();
                console.log('Statistics loaded:', result.data.statistics);
                updateStatistics(result.data.statistics);
            } catch (error) {
                console.error('Error loading statistics:', error);
                updateStatistics(DEFAULT_STATS);
            }
        }

        function updateStatistics(stats) {
            // Validate stats object
            if (!stats) {
                console.error('updateStatistics received null/undefined, using defaults');
                stats = DEFAULT_STATS;
            }
            
            document.getElementById('stat-total').textContent = stats.total || 0;
            document.getElementById('stat-teaching').textContent = stats.teaching || 0;
            document.getElementById('stat-nonteaching').textContent = stats.non_teaching || 0;
            document.getElementById('stat-active').textContent = stats.active || 0;
            document.getElementById('stat-leave').textContent = stats.on_leave || 0;
            document.getElementById('stat-retired').textContent = stats.retired || 0;
            console.log('Statistics updated:', stats);
        }

        async function applyFilters() {
            console.log('Applying filters...');
            const department = document.getElementById('filter-department').value;
            const designation = document.getElementById('filter-designation').value;
            const status = document.getElementById('filter-status').value;
            console.log('Filter values:', { department, designation, status });

            try {
                const params = new URLSearchParams();
                if (department) params.append('department_id', department);
                if (designation) params.append('designation', designation);
                if (status) params.append('employment_status', status);

                const url = `/api/staff?${params.toString()}`;
                console.log('Fetching staff data from:', url);

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch staff data');

                const result = await response.json();
                console.log('API Response:', result);
                
                // Validate response structure and extract staff array
                if (result.status === 'success' && result.data) {
                    if (!result.data.staff) {
                        console.error('Expected result.data.staff array, but it was missing. Data:', result.data);
                        staffData = [];
                    } else if (!Array.isArray(result.data.staff)) {
                        console.error('Expected result.data.staff to be an array, but got:', typeof result.data.staff);
                        staffData = [];
                    } else {
                        staffData = result.data.staff;
                        console.log('Staff data loaded:', staffData.length, 'records');
                    }
                    
                    // Update statistics if available
                    if (result.data.statistics) {
                        updateStatistics(result.data.statistics);
                    }
                } else {
                    staffData = [];
                    console.error('Expected response with status=success and data object, received:', result);
                }

                filtersApplied = true;
                renderStaffTable();
                showActionBar();
            } catch (error) {
                console.error('Error loading staff data:', error);
                alert('Failed to load staff data. Please try again.');
            }
        }

        function clearFilters() {
            console.log('Clearing filters...');
            document.getElementById('filter-department').value = '';
            document.getElementById('filter-designation').value = '';
            document.getElementById('filter-status').value = '';
            filtersApplied = false;
            hideActionBar();
            hideStaffTable();
            console.log('Filters cleared');
        }

        function showActionBar() {
            document.getElementById('action-bar').classList.add('visible');
            console.log('Action bar shown');
        }

        function hideActionBar() {
            document.getElementById('action-bar').classList.remove('visible');
            console.log('Action bar hidden');
        }

        function hideStaffTable() {
            document.getElementById('no-filters-message').style.display = 'block';
            document.getElementById('staff-table-container').style.display = 'none';
            console.log('Staff table hidden, showing no filters message');
        }

        function renderStaffTable() {
            console.log('Rendering staff table...');
            const tbody = document.getElementById('staff-table-body');
            tbody.innerHTML = '';

            // Defensive check: Validate staffData is an array
            // This should never trigger if applyFilters() works correctly
            if (!Array.isArray(staffData)) {
                console.error('Data validation failed: staffData is not an array');
                console.error('  Type:', typeof staffData);
                console.error('  Value:', staffData);
                console.error('  This indicates a data flow issue in applyFilters() or initialization.');
                staffData = [];
            }

            if (staffData.length === 0) {
                document.getElementById('no-filters-message').style.display = 'block';
                document.getElementById('staff-table-container').style.display = 'none';
                console.log('No staff data to display');
                return;
            }

            document.getElementById('no-filters-message').style.display = 'none';
            document.getElementById('staff-table-container').style.display = 'block';

            staffData.forEach(staff => {
                const row = document.createElement('tr');
                row.setAttribute('data-staff-id', staff.staff_id);
                row.onclick = function() { selectStaffRow(this, staff.staff_id); };
                row.innerHTML = `
                    <td>${staff.employee_id || ''}</td>
                    <td>${staff.full_name || ''}</td>
                    <td>${staff.dept_name || ''}</td>
                    <td>${staff.designation || ''}</td>
                    <td>${staff.employment_status || ''}</td>
                `;
                tbody.appendChild(row);
            });

            console.log('Staff table rendered with', staffData.length, 'rows');
        }

        function selectStaffRow(row, staffId) {
            console.log('Row selected, staff ID:', staffId);
            const previousSelected = document.querySelector('.simple-table tbody tr.selected');
            if (previousSelected) previousSelected.classList.remove('selected');
            row.classList.add('selected');
            currentStaffId = staffId;
            loadStaffDetails(staffId);
            openDetailsPanel();
        }

        async function loadStaffDetails(staffId) {
            try {
                console.log('Loading staff details for ID:', staffId);
                const response = await fetch(`/api/staff/${staffId}`);
                if (!response.ok) throw new Error('Failed to fetch staff details');
                const result = await response.json();
                console.log('Staff details loaded:', result);
                
                // Extract the actual staff data from result.data
                if (result.status === 'success' && result.data) {
                    populateStaffForm(result.data);
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error loading staff details:', error);
                alert('Failed to load staff details. Please try again.');
            }
        }

        function populateStaffForm(staff) {
            console.log('Populating form with staff data');
            document.getElementById('employee_id').value = staff.employee_id || '';
            document.getElementById('title').value = staff.title_prefix || '';
            document.getElementById('full_name').value = staff.full_name || '';
            document.getElementById('department').value = staff.department_id || '';
            document.getElementById('designation').value = staff.designation || '';
            document.getElementById('dob').value = staff.date_of_birth ? staff.date_of_birth.split('T')[0] : '';
            document.getElementById('gender').value = staff.gender || '';
            document.getElementById('qualification').value = staff.qualification || '';
            document.getElementById('experience').value = staff.years_of_experience || '';
            document.getElementById('mobile').value = staff.mobile_number || '';
            document.getElementById('email').value = staff.email || '';
            document.getElementById('joining_date').value = staff.date_of_joining ? staff.date_of_joining.split('T')[0] : '';
            document.getElementById('emergency_contact').value = staff.emergency_contact || '';
            document.getElementById('address').value = staff.address || '';
            document.getElementById('bank_name').value = staff.bank_name || '';
            document.getElementById('account_number').value = staff.account_number || '';
            document.getElementById('ifsc_code').value = staff.ifsc_code || '';
            document.getElementById('pan_number').value = staff.pan_card || '';
            document.getElementById('aadhaar_number').value = staff.aadhaar_number || '';
            document.getElementById('uan').value = staff.uan_number || '';
            document.getElementById('salary').value = staff.salary || '';
            document.getElementById('employment_status').value = staff.employment_status || 'Active';
            document.getElementById('is_hod').checked = staff.is_hod || false;
            document.getElementById('is_class_coordinator').checked = staff.is_class_coordinator || false;
            document.getElementById('is_exam_invigilator').checked = staff.is_exam_invigilator || false;
            document.getElementById('is_locked').checked = staff.is_locked || false;

            if (staff.photo_url) {
                document.getElementById('photo-preview').innerHTML = `<img src="${staff.photo_url}" alt="Staff Photo">`;
                console.log('Staff photo loaded');
            } else {
                document.getElementById('photo-preview').innerHTML = '<div class="photo-placeholder">üë§</div>';
            }
            document.getElementById('employee_id').setAttribute('readonly', 'readonly');
            console.log('Form populated successfully');
        }

        function openDetailsPanel() {
            console.log('Opening details panel');
            document.getElementById('details-panel').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        }

        function closeDetailsPanel() {
            console.log('Closing details panel');
            document.getElementById('details-panel').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
            const selected = document.querySelector('.simple-table tbody tr.selected');
            if (selected) selected.classList.remove('selected');
            currentStaffId = null;
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            console.log('Photo selected:', file.name);
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photo-preview').innerHTML = `<img src="${e.target.result}" alt="Staff Photo">`;
                console.log('Photo preview updated');
            };
            reader.readAsDataURL(file);
        }

        async function saveStaffDetails() {
            console.log('Saving staff details...');
            const employeeId = document.getElementById('employee_id').value.trim();
            const title = document.getElementById('title').value;
            const fullName = document.getElementById('full_name').value.trim();
            const department = document.getElementById('department').value;
            const designation = document.getElementById('designation').value;

            if (!employeeId || !title || !fullName || !department || !designation) {
                alert('Please fill all required fields (Employee ID, Title, Full Name, Department, Designation)');
                return;
            }

            const mobile = document.getElementById('mobile').value.trim();
            if (mobile && !/^\d{10}$/.test(mobile)) {
                alert('Mobile number must be exactly 10 digits');
                return;
            }

            const emergencyContact = document.getElementById('emergency_contact').value.trim();
            if (emergencyContact && !/^\d{10}$/.test(emergencyContact)) {
                alert('Emergency contact must be exactly 10 digits');
                return;
            }

            const aadhaar = document.getElementById('aadhaar_number').value.trim();
            if (aadhaar && !/^\d{12}$/.test(aadhaar)) {
                alert('Aadhaar number must be exactly 12 digits');
                return;
            }

            const pan = document.getElementById('pan_number').value.trim();
            if (pan && !/^[A-Z]{5}\d{4}[A-Z]$/.test(pan)) {
                alert('PAN number must be in format: ABCDE1234F (5 letters, 4 digits, 1 letter)');
                return;
            }

            const ifsc = document.getElementById('ifsc_code').value.trim();
            if (ifsc && ifsc.length !== 11) {
                alert('IFSC code must be exactly 11 characters');
                return;
            }

            const email = document.getElementById('email').value.trim();
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            const staffData = {
                employee_id: employeeId,
                title_prefix: title,
                full_name: fullName,
                department_id: department,
                designation: designation,
                date_of_birth: document.getElementById('dob').value || null,
                gender: document.getElementById('gender').value || null,
                qualification: document.getElementById('qualification').value.trim() || null,
                years_of_experience: document.getElementById('experience').value || null,
                mobile_number: mobile || null,
                email: email || null,
                date_of_joining: document.getElementById('joining_date').value || null,
                emergency_contact: emergencyContact || null,
                address: document.getElementById('address').value.trim() || null,
                bank_name: document.getElementById('bank_name').value.trim() || null,
                ifsc_code: ifsc || null,
                account_number: document.getElementById('account_number').value.trim() || null,
                pan_card: pan || null,
                aadhaar_number: aadhaar || null,
                uan_number: document.getElementById('uan').value.trim() || null,
                salary: document.getElementById('salary').value || null,
                employment_status: document.getElementById('employment_status').value,
                is_hod: document.getElementById('is_hod').checked,
                is_class_coordinator: document.getElementById('is_class_coordinator').checked,
                is_exam_invigilator: document.getElementById('is_exam_invigilator').checked,
                is_locked: document.getElementById('is_locked').checked
            };

            console.log('Staff data to save:', staffData);

            try {
                const url = currentStaffId ? `/api/staff/${currentStaffId}` : '/api/staff';
                const method = currentStaffId ? 'PUT' : 'POST';
                console.log(`Sending ${method} request to:`, url);

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(staffData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save staff');
                }

                const result = await response.json();
                console.log('Staff saved successfully:', result);
                alert('Staff details saved successfully!');
                closeDetailsPanel();
                applyFilters();
                loadStatistics();
            } catch (error) {
                console.error('Error saving staff:', error);
                alert('Failed to save staff details: ' + error.message);
            }
        }

        function openAddNewModal() {
            console.log('Opening add new staff panel');
            currentStaffId = null;
            ['employee_id','title','full_name','department','designation','dob','gender','qualification',
             'experience','mobile','email','joining_date','emergency_contact','address','bank_name',
             'account_number','ifsc_code','pan_number','aadhaar_number','uan','salary'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('employment_status').value = 'Active';
            ['is_hod','is_class_coordinator','is_exam_invigilator','is_locked'].forEach(id => {
                document.getElementById(id).checked = false;
            });
            document.getElementById('photo-preview').innerHTML = '<div class="photo-placeholder">üë§</div>';
            document.getElementById('employee_id').removeAttribute('readonly');
            document.getElementById('panel-title').textContent = 'Add New Staff';
            openDetailsPanel();
        }

        function openImportExcelModal() {
            console.log('Opening import excel modal');
            const modal = document.getElementById('import-excel-modal');
            if (modal) {
                modal.style.display = 'block';
                console.log('Import excel modal opened');
            } else {
                console.error('Import excel modal not found!');
            }
        }

        function closeImportExcelModal() {
            console.log('Closing import excel modal');
            const modal = document.getElementById('import-excel-modal');
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('excel-file-input').value = '';
            }
        }

        async function uploadExcelFile() {
            const fileInput = document.getElementById('excel-file-input');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select an Excel file');
                return;
            }
            console.log('Uploading Excel file:', file.name);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/staff/import/excel', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to import Excel');
                }
                const result = await response.json();
                console.log('Excel import result:', result);
                
                // Show detailed results
                let message = `‚úÖ Successfully imported ${result.data.imported} staff members`;
                if (result.data.skipped > 0) {
                    message += `\n‚ö†Ô∏è ${result.data.skipped} rows skipped`;
                    if (result.data.errors && result.data.errors.length > 0) {
                        message += '\n\nErrors:';
                        result.data.errors.slice(0, 5).forEach(err => {
                            message += `\n- Row ${err.row}: ${err.error}`;
                        });
                        if (result.data.errors.length > 5) {
                            message += `\n... and ${result.data.errors.length - 5} more errors`;
                        }
                    }
                }
                
                alert(message);
                closeImportExcelModal();
                applyFilters();
                loadStatistics();
            } catch (error) {
                console.error('Error importing Excel:', error);
                alert('Failed to import Excel: ' + error.message);
            }
        }

        async function exportToExcel() {
            console.log('Exporting staff data to Excel...');
            try {
                const params = new URLSearchParams();
                const department = document.getElementById('filter-department').value;
                const designation = document.getElementById('filter-designation').value;
                const status = document.getElementById('filter-status').value;
                if (department) params.append('department_id', department);
                if (designation) params.append('designation', designation);
                if (status) params.append('employment_status', status);

                const url = `/api/staff/export/excel?${params.toString()}`;
                console.log('Downloading from:', url);
                window.location.href = url;
                console.log('Export initiated');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Failed to export data: ' + error.message);
            }
        }

        function openImportPhotosModal() {
            console.log('Opening import photos modal');
            const modal = document.getElementById('import-photos-modal');
            if (modal) {
                modal.style.display = 'block';
                console.log('Import photos modal opened');
            } else {
                console.error('Import photos modal not found!');
            }
        }

        function closeImportPhotosModal() {
            console.log('Closing import photos modal');
            const modal = document.getElementById('import-photos-modal');
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('photos-zip-input').value = '';
            }
        }

        async function uploadPhotosZip() {
            const fileInput = document.getElementById('photos-zip-input');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a ZIP file');
                return;
            }
            console.log('Uploading photos ZIP:', file.name);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/staff/import-photos', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to import photos');
                }
                const result = await response.json();
                console.log('Photos import result:', result);
                
                // Show detailed results
                let message = `‚úÖ Successfully imported ${result.data.uploaded} photos`;
                if (result.data.failed > 0) {
                    message += `\n‚ö†Ô∏è ${result.data.failed} photos skipped`;
                    if (result.data.errors && result.data.errors.length > 0) {
                        message += '\n\nErrors:';
                        result.data.errors.slice(0, 5).forEach(err => {
                            message += `\n- ${err.filename}: ${err.error}`;
                        });
                        if (result.data.errors.length > 5) {
                            message += `\n... and ${result.data.errors.length - 5} more errors`;
                        }
                    }
                }
                
                alert(message);
                closeImportPhotosModal();
                applyFilters(); // Refresh to show updated photos
            } catch (error) {
                console.error('Error importing photos:', error);
                alert('Failed to import photos: ' + error.message);
            }
        }

        function generateSampleExcel() {
            console.log('Generating sample Excel...');
            window.location.href = '/api/staff/sample-excel';
        }
    </script>
</body>
</html>
